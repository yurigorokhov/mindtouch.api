(function(){var j=function(c,f){if(c>="a"&&c<="z"||c>="A"&&c<="Z"||c>="0"&&c<="9")return true;switch(c){case "'":case "(":case ")":case "*":case "-":case ".":case "_":case "!":return true}switch(f){case 3:switch(c){case "#":return true}case 2:switch(c){case "/":case ":":case "~":case "$":case ",":case ";":case "|":return true}case 1:switch(c){case "@":case "^":return true}break;case 0:switch(c){case "&":case "=":return true}}return false},h=function(c,f){f||(f="segment");for(var b=[],d=c.encodeUtf8().toBytes(),
a=0;a<d.length;++a){var e=d[a],g=String.fromCharCode(e);if(j(g,f))b.push(d[a]);else if(g==" ")b.push(43);else{b.push(37);b.push((e>>4&15)<=9?(e>>4&15)+48:(e>>4&15)-10+97);b.push((e&15)<=9?(e&15)+48:(e&15)-10+97)}}return String.fromCharCode.apply(null,b)};_.extend(String.prototype,{encodeUtf8:function(){for(var c="",f=0;f<this.length;f++){var b=this.charCodeAt(f);if(b<128)c+=String.fromCharCode(b);else{if(b>127&&b<2048)c+=String.fromCharCode(b>>6|192);else{c+=String.fromCharCode(b>>12|224);c+=String.fromCharCode(b>>
6&63|128)}c+=String.fromCharCode(b&63|128)}}return c},decodeUtf8:function(){for(var c="",f=0,b=c1=c2=0;f<this.length;){b=this.charCodeAt(f);if(b<128){c+=String.fromCharCode(b);f++}else if(b>191&&b<224){c2=this.charCodeAt(f+1);c+=String.fromCharCode((b&31)<<6|c2&63);f+=2}else{c2=this.charCodeAt(f+1);c3=this.charCodeAt(f+2);c+=String.fromCharCode((b&15)<<12|(c2&63)<<6|c3&63);f+=3}}return c},encodeBase64:function(){if(/([^\u0000-\u00ff])/.test(this))throw Error("Can't base64 encode non-ASCII characters.");
for(var c=0,f,b,d,a=[];c<this.length;){f=this.charCodeAt(c);d=c%3;switch(d){case 0:a.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(f>>2));break;case 1:a.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((b&3)<<4|f>>4));break;case 2:a.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((b&15)<<2|f>>6));a.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(f&63))}b=f;c++}if(d==0){a.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((b&
3)<<4));a.push("==")}else if(d==1){a.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((b&15)<<2));a.push("=")}return a.join("")},decodeBase64:function(){var c=this;c=c.replace(/\s/g,"");if(!/^[a-z0-9\+\/\s]+\={0,2}$/i.test(c)||c.length%4>0)throw Error("Not a base64-encoded string.");var f,b,d,a=0,e=[];for(c=c.replace(/=/g,"");a<c.length;){f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(c.charAt(a));d=a%4;switch(d){case 1:e.push(String.fromCharCode(b<<
2|f>>4));break;case 2:e.push(String.fromCharCode((b&15)<<4|f>>2));break;case 3:e.push(String.fromCharCode((b&3)<<6|f))}b=f;a++}return e.join("")},toBytes:function(){for(var c,f,b=[],d=0;d<this.length;d++){c=this.charCodeAt(d);f=[];do{f.push(c&255);c>>=8}while(c);b=b.concat(f.reverse())}return b},encodeUrlFragment:function(){return h(this,3)},encodeUrlQuery:function(){return h(this,2)},encodeUrlSegment:function(){return h(this,1)},encodeUrlUserInfo:function(){return h(this,0)}})})();(function(){var j=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};_.mixin({guid:function(){return j()+j()+"-"+j()+"-"+j()+"-"+j()+"-"+j()+j()+j()},callOrPublish:function(h,c){if(_.isFunction(h))h.apply(null,[c]);else if(_.isString(h))PageBus.publish(h,c);else throw Error("invalid plug callback");}})})();(function(){var j=this,h=j.PageBus={version:"3.0.0"};h.Subscription=function(a,e,g){this.id=_.uniqueId();this.callback=e;this.data=g;this.context=a;this.channel=null};_.extend(h.Subscription.prototype,{dispose:function(){if(this.channel)try{this.channel.unsubscribe(this)}finally{this.channel=null}}});h.Channel=function(){this.channels={};this.subscribers=[];this.lastMessage=null};_.extend(h.Channel.prototype,{subscribe:function(a,e,g){if(e===a.length){g.channel=this;this.subscribers.push(g);return g}var i=
this.channels[a[e]]||(this.channels[a[e]]=new h.Channel);try{return i.subscribe(a,e+1,g)}catch(k){i.isEmpty()&&delete this.channels[a[e]];throw k;}},publish:function(a,e,g,i,k){if(e===a.length){this.lastMessage=i;_.each(this.subscribers,function(m){k.push(_.bind(m.callback,m.context,g,i,m.data))})}else{var l=this.channels[a[e]]||(this.channels[a[e]]=new h.Channel);l.publish(a,e+1,g,i,k);l=this.channels["*"];_.isUndefined(l)||_.each(l.subscribers,function(m){k.push(_.bind(m.callback,m.context,g,i,
m.data))})}},query:function(a,e){if(e===a.length)return this.lastMessage;var g=this.channels[a[e]];return!_.isUndefined(g)?g.query(a,e+1):null},unsubscribe:function(a){for(var e=0;e<this.subscribers.length;++e)if(a.id===this.subscribers[e].id){this.subscribers.splice(e,1);break}},isEmpty:function(){return this.subscribers.length===0&&_.isEmpty(this.channels)&&this.lastMessage===null}});var c=new h.Channel,f=0,b=[],d=function(a,e){if(a===null||a==="")throw Error("PageBus.BadName");for(var g=a.split("."),
i=0;i<g.length;++i)if(g[i]===""||g[i].indexOf("*")!==-1&&(!e||g[i]!=="*"))throw Error("PageBus.BadName");return g};_.extend(h,{reset:function(){c=new h.Channel},subscribe:function(a,e,g,i){if(_.isFunction(e)){i=g;g=e;e=null}return c.subscribe(d(a,true),0,new h.Subscription(e||j,g,i))},publish:function(a,e){c.publish(d(a,false),0,a,e,b);if(f===0)try{for(++f;b.length;){var g=b;b=[];_.each(g,function(i){i()})}}finally{--f}},query:function(a){return c.query(d(a,false),0)},unsubscribe:function(a){a.dispose()}})})();(function(){this.Plug=function(b,d){if(!b)throw Error("missing url argument");d||(d={});this.headers=d.headers||{};_.extend(this,_.isString(b)?f(b):b,d)};var j=function(b){return _.extend(b,{getStatusText:function(){switch(this.status){case 100:return"Continue";case 101:return"Switching Protocols";case 200:return"Ok";case 201:return"Created";case 202:return"Accepted";case 203:return"Non-Authoritative Information";case 204:return"No Content";case 205:return"Reset Content";case 206:return"Partial Content";
case 207:return"Multi-Status";case 300:return"Multiple Choices";case 301:return"Moved Permanently";case 302:return"Found";case 303:return"See Other";case 304:return"Not Modified";case 305:return"Use Proxy";case 306:return"(Reserved)";case 307:return"Temporary Redirect";case 400:return"Bad Request";case 401:return"Unauthorized";case 402:return"Payment Required";case 403:return"Forbidden";case 404:return"Not Found";case 405:return"Method Not Allowed";case 406:return"Not Acceptable";case 407:return"Proxy Authentication";
case 408:return"Request Timeout";case 409:return"Conflict";case 410:return"Gone";case 411:return"Length Required";case 412:return"Precondition Failed";case 413:return"Request Entity Too Large";case 414:return"Request-URI Too Long";case 415:return"Unsupported Media Type";case 416:return"Requested Range Not Satisfiable";case 417:return"Expectation Failed";case 422:return"Unprocessable Entity";case 423:return"Locked";case 424:return"Failed Dependency";case 500:return"Internal Server Error";case 501:return"Not Implemented";
case 502:return"Bad Gateway";case 503:return"Service Unavailable";case 504:return"Gateway Timeout";case 505:return"HTTP Version Not Supported";case 507:return"Insufficient Storage"}return"(Unknown)"},isSuccess:function(){return this.status>=200&&this.status<300||this.status==304},getETag:function(){var d=this.getResponseHeader("ETag"),a=this.getResponseHeader("Content-Encoding");if(a&&a.length>0)d=d.replace("-"+a,"");return d},errorMessage:function(){return(mesage||"Request failed")+" (status: "+
this.status+" - "+this.getStatusText()+")"}})},h=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(#.*)?)/,c=["original","protocol","authority","userInfo","user","password","hostname","port","relative","path","directory","file","query","fragment"],f=function(b){if(!b)return{original:"",protocol:null,authority:null,userInfo:null,user:null,password:null,hostname:null,
port:null,relative:null,path:null,directory:null,file:null,query:null,params:null,fragment:null,segments:[]};for(var d=h.exec(b),a={},e=0;e<c.length;++e)a[c[e]]=d[e]||null;a.fragment=a.fragment!==null?decodeURIComponent(a.fragment.substr(1)).decodeUtf8():null;a.trailingSlash=a.path?a.path[a.path.length-1]==="/":false;a.params=b.indexOf("?")<0?null:function(){var g={};if(a.query!==null)for(var i=a.query.split("&"),k=0;k<i.length;++k)if(i[k]){var l=i[k].split("=");g[l[0]]=l.length>1?decodeURIComponent(l[1]).decodeUtf8():
null}return g}();a.segments=function(){var g=a.path.replace(/^\//,"").replace(/\/$/,"").split("/");if(g.length===1&&g[0].length===0)g=[];else for(var i=0;i<g.length;++i)g[i]=decodeURIComponent(g[i]).decodeUtf8();return g}();a.protocol=a.protocol?a.protocol:null;a.hostname=a.protocol?a.hostname||"":null;a.implicitPort=a.port===null;if(a.implicitPort&&a.protocol){switch(a.protocol){case "http":a.port="80";break;case "https":a.port="443";break;case "ftp":a.port="21";break;case "file":a.port=null;break;
default:a.port=0}d=a.protocol+"://"+a.hostname+":";a.implicitPort=b.substr(0,d.length)!==d}return a};_.extend(this.Plug.prototype,{getUrl:function(){var b="";if(this.protocol)b+=this.protocol+"://"+this.hostname;if(!this.implicitPort&&this.port)b+=":"+this.port;for(var d=0;d<this.segments.length;++d)b+="/"+this.segments[d].encodeUrlSegment();if(this.trailingSlash)b+="/";if(this.params){b+="?";var a=true;_.each(this.params,function(e,g){a||(b+="&");a=false;b+=g.encodeUrlQuery();if(e!==null)b+="="+
e.encodeUrlQuery()})}if(this.fragment!==null)b+="#"+this.fragment.encodeUrlFragment();return b},get:function(b,d){var a=b!=null,e=$.ajax({context:this,async:a,url:this.getUrl(),type:d||"GET",cache:false,beforeSend:this._beforeSend,complete:a&&function(g){j(g);if(b)_.callOrPublish(b,g);else if(!g.isSuccess())throw Error("Plug "+(this.headers["X-HTTP-Method-Override"]||"GET")+" request failed for "+this.getUrl()+" (status: "+g.status+" - "+g.getStatusText()+")");}});if(!a){j(e);return e}},post:function(b,
d,a){var e=a!=null;b=$.ajax({context:this,async:e,url:this.getUrl(),type:"POST",data:b,contentType:d,processData:false,beforeSend:this._beforeSend,complete:e&&function(g){j(g);if(a)_.callOrPublish(a,g);else if(!g.isSuccess())throw Error("Plug "+(this.headers["X-HTTP-Method-Override"]||"POST")+" request failed for "+this.getUrl()+" (status: "+g.status+" - "+g.getStatusText()+")");}});if(!e){j(b);return b}},put:function(b,d,a){return this.withHeader("X-HTTP-Method-Override","PUT").post(b,d,a)},head:function(b){return this.get(b,
"HEAD")},options:function(b){return this.get(b,"OPTIONS")},del:function(b){return this.withHeader("X-HTTP-Method-Override","DELETE").post(null,null,b)},at:function(){for(var b=0;b<arguments.length;++b)if(_.isNull(arguments[b]))throw Error("argument "+(b+1)+" is null");b=this.segments.concat.apply(this.segments,_.map(arguments,function(d){return _.isString(d)?d:new String(d)}));return new Plug(this,_.extend({},this.options,{segments:b,trailingSlash:false}))},withParam:function(b,d){var a=_.extend({},
this.params);a[b]=d;return new Plug(this,_.extend({},this.options,{params:a}))},withParams:function(b){b=_.extend({},this.params,b);return new Plug(this,_.extend({},this.options,{params:b}))},withoutParam:function(b){var d=_.extend({},this.params);delete d[b];return new Plug(this,_.extend({},this.options,{params:d}))},withTrailingSlash:function(){return new Plug(this,_.extend({},this.options,{trailingSlash:true}))},withoutTrailingSlash:function(){return new Plug(this,_.extend({},this.options,{trailingSlash:true}))},
withHeader:function(b,d){var a=_.extend({},this.headers);a[b]=d;return new Plug(this,_.extend({},this.options,{headers:a}))},withHeaders:function(b){b=_.extend({},this.headers,b);return new Plug(this,_.extend({},this.options,{headers:b}))},withoutHeader:function(b){var d=_.extend({},this.headers);delete d[b];return new Plug(this,_.extend({},this.options,{headers:d}))},_beforeSend:function(b){this.headers&&$.each(this.headers,function(d,a){typeof a!="object"&&typeof a!="function"&&b.setRequestHeader(d,
a)});this.protocol==="https"&&b.setRequestHeader("Front-End-Https","On");return true}})})();(function(){this.Property=function(h){if(_.isString(h)){var c=h.indexOf("#");h=c>=0?{name:h.substr(0,c),namespace:h.substr(c+1)}:{name:h}}h||(h={});this.name=h.name||"default";this.namespace=h.namespace||"urn:custom.mindtouch.com";this.property=this.namespace+"#"+this.name;this.mime=h.mime||"application/json; charset=utf-8";this.serialize=h.serialize||JSON.stringify;this.deserialize=h.deserialize||JSON.parse;this.etag=this.value=null;h=(new Plug(Deki.BaseHref)).at("@api","deki","pages",Deki.PageId,
"properties");this.plug=(new Plug(h)).at(this.property.encodeUrlSegment())};var j=function(h,c,f,b){if(b)_.callOrPublish(b,{status:f.status,text:f.getStatusText(),xhr:f});else throw Error(f.errorMessage("An error occurred trying to "+c+" property '"+h+"'"));};_.extend(this.Property.prototype,{get:function(h,c){var f=this,b=function(a){if(a.isSuccess()){if(a.status!=304){f.value=f.deserialize(a.responseText);f.etag=a.getETag()}if(h)_.callOrPublish(h,f);else return f.value}return j(f.property,"get",
a,c)},d=this.plug;if(h)d.get(b);else{d=d.get();return b(d)}},set:function(h,c,f){var b=this,d=function(e){if(e.isSuccess()){b.value=h;b.etag=e.getETag();if(c)_.callOrPublish(c,b);else return b.value}return j(b.property,"set",e,f)},a=this.plug.withParam("abort","never");if(this.etag)a=a.withHeader("ETag",this.etag);if(c)a.put(this.serialize(h),this.mime,d);else{a=a.put(this.serialize(h),this.mime);return d(a)}},destroy:function(h,c){var f=this,b=function(a){if(a.isSuccess()){f.value=null;f.etag=null;
if(h)_.callOrPublish(h,f);else return f.value}return j(f.property,"delete",a,c)};if(h)plug.del(b);else{var d=plug.del();return b(d)}}})})();
