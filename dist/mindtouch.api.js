(function(){var i=function(a,b){if(a>="a"&&a<="z"||a>="A"&&a<="Z"||a>="0"&&a<="9")return true;switch(a){case "'":case "(":case ")":case "*":case "-":case ".":case "_":case "!":return true}switch(b){case 3:switch(a){case "#":return true}case 2:switch(a){case "/":case ":":case "~":case "$":case ",":case ";":case "|":return true}case 1:switch(a){case "@":case "^":return true}break;case 0:switch(a){case "&":case "=":return true}}return false},f=function(a,b){b||(b="segment");for(var c=[],g=a.encodeUtf8().toBytes(),
d=0;d<g.length;++d){var e=g[d],h=String.fromCharCode(e);if(i(h,b))c.push(g[d]);else if(h==" ")c.push(43);else{c.push(37);c.push((e>>4&15)<=9?(e>>4&15)+48:(e>>4&15)-10+97);c.push((e&15)<=9?(e&15)+48:(e&15)-10+97)}}return String.fromCharCode.apply(null,c)};_.extend(String.prototype,{encodeUtf8:function(){for(var a="",b=0;b<this.length;b++){var c=this.charCodeAt(b);if(c<128)a+=String.fromCharCode(c);else{if(c>127&&c<2048)a+=String.fromCharCode(c>>6|192);else{a+=String.fromCharCode(c>>12|224);a+=String.fromCharCode(c>>
6&63|128)}a+=String.fromCharCode(c&63|128)}}return a},decodeUtf8:function(){for(var a="",b=0,c=c1=c2=0;b<this.length;){c=this.charCodeAt(b);if(c<128){a+=String.fromCharCode(c);b++}else if(c>191&&c<224){c2=this.charCodeAt(b+1);a+=String.fromCharCode((c&31)<<6|c2&63);b+=2}else{c2=this.charCodeAt(b+1);c3=this.charCodeAt(b+2);a+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);b+=3}}return a},encodeBase64:function(){if(/([^\u0000-\u00ff])/.test(this))throw Error("Can't base64 encode non-ASCII characters.");
for(var a=0,b,c,g,d=[];a<this.length;){b=this.charCodeAt(a);g=a%3;switch(g){case 0:d.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(b>>2));break;case 1:d.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((c&3)<<4|b>>4));break;case 2:d.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((c&15)<<2|b>>6));d.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(b&63))}c=b;a++}if(g==0){d.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((c&
3)<<4));d.push("==")}else if(g==1){d.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((c&15)<<2));d.push("=")}return d.join("")},decodeBase64:function(){var a=this;a=a.replace(/\s/g,"");if(!/^[a-z0-9\+\/\s]+\={0,2}$/i.test(a)||a.length%4>0)throw Error("Not a base64-encoded string.");var b,c,g,d=0,e=[];for(a=a.replace(/=/g,"");d<a.length;){b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(a.charAt(d));g=d%4;switch(g){case 1:e.push(String.fromCharCode(c<<
2|b>>4));break;case 2:e.push(String.fromCharCode((c&15)<<4|b>>2));break;case 3:e.push(String.fromCharCode((c&3)<<6|b))}c=b;d++}return e.join("")},toBytes:function(){for(var a,b,c=[],g=0;g<this.length;g++){a=this.charCodeAt(g);b=[];do{b.push(a&255);a>>=8}while(a);c=c.concat(b.reverse())}return c},encodeUrlFragment:function(){return f(this,3)},encodeUrlQuery:function(){return f(this,2)},encodeUrlSegment:function(){return f(this,1)},encodeUrlUserInfo:function(){return f(this,0)}})})();(function(){var i=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};_.mixin({guid:function(){return i()+i()+"-"+i()+"-"+i()+"-"+i()+"-"+i()+i()+i()},callOrPublish:function(f,a){if(_.isFunction(f))f.apply(null,[a]);else if(_.isString(f))PageBus.publish(f,a);else throw Error("invalid plug callback");}})})();(function(){var i=this,f=i.PageBus={version:"3.0.0"};f.Subscription=function(d,e,h){this.id=_.uniqueId();this.callback=e;this.data=h;this.context=d;this.channel=null};_.extend(f.Subscription.prototype,{dispose:function(){if(this.channel)try{this.channel.unsubscribe(this)}finally{this.channel=null}}});f.Channel=function(){this.channels={};this.subscribers=[];this.lastMessage=null};_.extend(f.Channel.prototype,{subscribe:function(d,e,h){if(e===d.length){h.channel=this;this.subscribers.push(h);return h}var j=
this.channels[d[e]]||(this.channels[d[e]]=new f.Channel);try{return j.subscribe(d,e+1,h)}catch(l){j.isEmpty()&&delete this.channels[d[e]];throw l;}},publish:function(d,e,h,j,l){if(e===d.length){this.lastMessage=j;_.each(this.subscribers,function(k){l.push(_.bind(k.callback,k.context,h,j,k.data))})}else{var m=this.channels[d[e]]||(this.channels[d[e]]=new f.Channel);m.publish(d,e+1,h,j,l);m=this.channels["*"];_.isUndefined(m)||_.each(m.subscribers,function(k){l.push(_.bind(k.callback,k.context,h,j,
k.data))})}},query:function(d,e){if(e===d.length)return this.lastMessage;var h=this.channels[d[e]];return!_.isUndefined(h)?h.query(d,e+1):null},unsubscribe:function(d){for(var e=0;e<this.subscribers.length;++e)if(d.id===this.subscribers[e].id){this.subscribers.splice(e,1);break}},isEmpty:function(){return this.subscribers.length===0&&_.isEmpty(this.channels)&&this.lastMessage===null}});var a=new f.Channel,b=0,c=[],g=function(d,e){if(d===null||d==="")throw Error("PageBus.BadName");for(var h=d.split("."),
j=0;j<h.length;++j)if(h[j]===""||h[j].indexOf("*")!==-1&&(!e||h[j]!=="*"))throw Error("PageBus.BadName");return h};_.extend(f,{reset:function(){a=new f.Channel},subscribe:function(d,e,h,j){if(_.isFunction(e)){j=h;h=e;e=null}return a.subscribe(g(d,true),0,new f.Subscription(e||i,h,j))},publish:function(d,e){a.publish(g(d,false),0,d,e,c);if(b===0)try{for(++b;c.length;){var h=c;c=[];_.each(h,function(j){j()})}}finally{--b}},query:function(d){return a.query(g(d,false),0)},unsubscribe:function(d){d.dispose()}})})();(function(){this.Plug=function(a,b){if(!a)throw Error("missing url argument");b||(b={});this.headers=b.headers||{};_.extend(this,_.isString(a)?f(a):a,b)};var i=function(a){return _.extend(a,{getStatusText:function(){switch(this.status){case 100:return"Continue";case 101:return"Switching Protocols";case 200:return"Ok";case 201:return"Created";case 202:return"Accepted";case 203:return"Non-Authoritative Information";case 204:return"No Content";case 205:return"Reset Content";case 206:return"Partial Content";
case 207:return"Multi-Status";case 300:return"Multiple Choices";case 301:return"Moved Permanently";case 302:return"Found";case 303:return"See Other";case 304:return"Not Modified";case 305:return"Use Proxy";case 306:return"(Reserved)";case 307:return"Temporary Redirect";case 400:return"Bad Request";case 401:return"Unauthorized";case 402:return"Payment Required";case 403:return"Forbidden";case 404:return"Not Found";case 405:return"Method Not Allowed";case 406:return"Not Acceptable";case 407:return"Proxy Authentication";
case 408:return"Request Timeout";case 409:return"Conflict";case 410:return"Gone";case 411:return"Length Required";case 412:return"Precondition Failed";case 413:return"Request Entity Too Large";case 414:return"Request-URI Too Long";case 415:return"Unsupported Media Type";case 416:return"Requested Range Not Satisfiable";case 417:return"Expectation Failed";case 422:return"Unprocessable Entity";case 423:return"Locked";case 424:return"Failed Dependency";case 500:return"Internal Server Error";case 501:return"Not Implemented";
case 502:return"Bad Gateway";case 503:return"Service Unavailable";case 504:return"Gateway Timeout";case 505:return"HTTP Version Not Supported";case 507:return"Insufficient Storage"}return"(Unknown)"},isSuccess:function(){return this.status>=200&&this.status<300||this.status==304},getETag:function(){var b=this.getResponseHeader("ETag"),c=this.getResponseHeader("Content-Encoding");if(c&&c.length>0)b=b.replace("-"+c,"");return b},errorMessage:function(){return(mesage||"Request failed")+" (status: "+
this.status+" - "+this.getStatusText()+")"}})},f=function(a){if(!a)return{original:"",protocol:"",host:"",port:"0",params:null,fragment:null,segments:[]};var b=document.createElement("a");b.href=a;var c={original:a,port:b.port&&b.port!=="0"?b.port:null,params:function(){for(var d=a.indexOf("?")>=0?{}:null,e=b.search.replace(/^\?/,"").split("&"),h=0;h<e.length;h++)if(e[h]){var j=e[h].split("=");d[j[0]]=j.length>1?decodeURIComponent(j[1]).decodeUtf8():null}return d}(),fragment:a.indexOf("#")!=-1?decodeURIComponent(b.hash.substr(1)).decodeUtf8():
null,segments:function(){var d=b.pathname.replace(/^\//,"").replace(/\/$/,"").split("/");if(d.length===1&&d[0].length===0)d=[];else for(var e=0;e<d.length;++e)d[e]=decodeURIComponent(d[e]).decodeUtf8();return d}(),trailingSlash:b.pathname?b.pathname[b.pathname.length-1]=="/":false};c.protocol=b.protocol!=="file:"||a.substr(0,7)==="file://"?b.protocol.replace(":",""):null;c.hostname=c.protocol?b.hostname:null;c.implicitPort=c.port===null;if(c.implicitPort&&c.protocol){switch(c.protocol){case "http":c.port=
"80";break;case "https":c.port="443";break;case "ftp":c.port="21";break;case "file":c.port=null;break;default:c.port=0}var g=c.protocol+"://"+c.hostname+":";c.implicitPort=a.substr(0,g.length)!==g}return c};_.extend(this.Plug.prototype,{getUrl:function(){var a="";if(this.protocol)a+=this.protocol+"://"+this.hostname;if(!this.implicitPort&&this.port)a+=":"+this.port;for(var b=0;b<this.segments.length;++b)a+="/"+this.segments[b].encodeUrlSegment();if(this.trailingSlash)a+="/";if(this.params){a+="?";
var c=true;_.each(this.params,function(g,d){c||(a+="&");c=false;a+=d.encodeUrlQuery();if(g!==null)a+="="+g.encodeUrlQuery()})}if(this.fragment!==null)a+="#"+this.fragment.encodeUrlFragment();return a},get:function(a,b){var c=a!=null,g=$.ajax({context:this,async:c,url:this.getUrl(),type:b||"GET",cache:false,beforeSend:this._beforeSend,complete:c&&function(d){i(d);if(a)_.callOrPublish(a,d);else if(!d.isSuccess())throw Error("Plug "+(this.headers["X-HTTP-Method-Override"]||"GET")+" request failed for "+
this.getUrl()+" (status: "+d.status+" - "+d.getStatusText()+")");}});if(!c){i(g);return g}},post:function(a,b,c){var g=c!=null;a=$.ajax({context:this,async:g,url:this.getUrl(),type:"POST",data:a,contentType:b,processData:false,beforeSend:this._beforeSend,complete:g&&function(d){i(d);if(c)_.callOrPublish(c,d);else if(!d.isSuccess())throw Error("Plug "+(this.headers["X-HTTP-Method-Override"]||"POST")+" request failed for "+this.getUrl()+" (status: "+d.status+" - "+d.getStatusText()+")");}});if(!g){i(a);
return a}},put:function(a,b,c){return this.withHeader("X-HTTP-Method-Override","PUT").post(a,b,c)},head:function(a){return this.get(a,"HEAD")},options:function(a){return this.get(a,"OPTIONS")},del:function(a){return this.withHeader("X-HTTP-Method-Override","DELETE").post(null,null,a)},at:function(){for(var a=0;a<arguments.length;++a)if(_.isNull(arguments[a]))throw Error("argument "+(a+1)+" is null");a=this.segments.concat.apply(this.segments,_.map(arguments,function(b){return _.isString(b)?b:new String(b)}));
return new Plug(this,_.extend({},this.options,{segments:a,trailingSlash:false}))},withParam:function(a,b){var c=_.extend({},this.params);c[a]=b;return new Plug(this,_.extend({},this.options,{params:c}))},withParams:function(a){a=_.extend({},this.params,a);return new Plug(this,_.extend({},this.options,{params:a}))},withoutParam:function(a){var b=_.extend({},this.params);delete b[a];return new Plug(this,_.extend({},this.options,{params:b}))},withTrailingSlash:function(){return new Plug(this,_.extend({},
this.options,{trailingSlash:true}))},withoutTrailingSlash:function(){return new Plug(this,_.extend({},this.options,{trailingSlash:true}))},withHeader:function(a,b){var c=_.extend({},this.headers);c[a]=b;return new Plug(this,_.extend({},this.options,{headers:c}))},withHeaders:function(a){a=_.extend({},this.headers,a);return new Plug(this,_.extend({},this.options,{headers:a}))},withoutHeader:function(a){var b=_.extend({},this.headers);delete b[a];return new Plug(this,_.extend({},this.options,{headers:b}))},
_beforeSend:function(a){this.headers&&$.each(this.headers,function(b,c){typeof c!="object"&&typeof c!="function"&&a.setRequestHeader(b,c)});this.protocol==="https"&&a.setRequestHeader("Front-End-Https","On");return true}})})();(function(){this.Property=function(f){if(_.isString(f)){var a=f.indexOf("#");f=a>=0?{name:f.substr(0,a),namespace:f.substr(a+1)}:{name:f}}f||(f={});this.name=f.name||"default";this.namespace=f.namespace||"urn:custom.mindtouch.com";this.property=this.namespace+"#"+this.name;this.mime=f.mime||"application/json; charset=utf-8";this.serialize=f.serialize||JSON.stringify;this.deserialize=f.deserialize||JSON.parse;this.etag=this.value=null;f=(new Plug(Deki.BaseHref)).at("@api","deki","pages",Deki.PageId,
"properties");this.plug=(new Plug(f)).at(this.property.encodeUrlSegment())};var i=function(f,a,b,c){if(c)_.callOrPublish(c,{status:b.status,text:b.getStatusText(),xhr:b});else throw Error(b.errorMessage("An error occurred trying to "+a+" property '"+f+"'"));};_.extend(this.Property.prototype,{get:function(f,a){var b=this,c=function(d){if(d.isSuccess()){if(d.status!=304){b.value=b.deserialize(d.responseText);b.etag=d.getETag()}if(f)_.callOrPublish(f,b);else return b.value}return i(b.property,"get",
d,a)},g=this.plug;if(f)g.get(c);else{g=g.get();return c(g)}},set:function(f,a,b){var c=this,g=function(e){if(e.isSuccess()){c.value=f;c.etag=e.getETag();if(a)_.callOrPublish(a,c);else return c.value}return i(c.property,"set",e,b)},d=this.plug.withParam("abort","never");if(this.etag)d=d.withHeader("ETag",this.etag);if(a)d.put(this.serialize(f),this.mime,g);else{d=d.put(this.serialize(f),this.mime);return g(d)}},destroy:function(f,a){var b=this,c=function(d){if(d.isSuccess()){b.value=null;b.etag=null;
if(f)_.callOrPublish(f,b);else return b.value}return i(b.property,"delete",d,a)};if(f)plug.del(c);else{var g=plug.del();return c(g)}}})})();
